<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <title>Two-Phase Simplex</title>
    <style>
        html {
            background-color: #151617;
            color: white;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        button {
            background-color: #20324d;
            color: white;
            border: none;
            /* border-radius: 5px; */
            padding: 2px 10px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            margin-right: 10px;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:active {
            /* transform: scale(0.98); */
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        input {
            width: 50px;
            margin-right: 5px;
            background-color: #212425;
            border: 1px solid #444;
            color: white;
            margin-left: 10px;
        }

        input[type="number"] {
            -moz-appearance: textfield;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        select {
            margin-left: 5px;
            background-color: #212425;
            border: 1px solid #444;
            color: white;
        }

        .row {
            display: flex;
            margin-bottom: 10px;
            align-items: center;
        }

        .cell {
            width: 80px;
            text-align: right;
            margin-right: 5px;
            box-sizing: border-box;
        }

        .highlight {
            color: greenyellow;
        }

        .header-row {
            font-weight: bold;
        }

        label {
            margin-right: 20px;
        }

        input[type="radio"] {
            margin-right: 5px;
        }

        p {
            font-weight: bold;
            color: white;
        }

        .constraint {
            margin-bottom: 10px;
        }

        .tableauContainer {
            margin-bottom: 20px;
            /* height: 300px; */
            overflow-y: auto;
            overflow-x: auto;
            width: 100%;
        }

        .tableauContainer .row {
            flex-wrap: nowrap;
        }

        .tableauContainer .cell {
            min-width: 80px;
        }

        #objectiveFunction,
        #constraintsContainer {
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <h1>Two-Phase Simplex</h1>

    <h3 id="loadingStatus">Loading...</h3>

    <div hidden id="hiddenUntilLoad">
        <div>
            <label><input type="radio" name="problemType" value="Max" checked> Max</label>
            <label><input type="radio" name="problemType" value="Min"> Min</label>
        </div>

        <p id="problemTypeText">Problem is: Max</p>

        <div class="row">
            <button id="addDecisionVar">decision variables +</button>
            <button id="removeDecisionVar">decision variables -</button>
        </div>

        <div id="objectiveFunction" class="row"></div>

        <div class="row">
            <button id="addConstraint">Constraint +</button>
            <button id="removeConstraint">Constraint -</button>
        </div>

        <div id="constraintsContainer"></div>


        <div class="row">
            <button id="solveButton">Solve</button>
            <button id="resetButton" style="margin-left: 25px; background-color: red">Reset</button>
        </div>

    </div>

    <script>
        let problemType = "Max";
        let amtOfObjVars = 2;
        let amtOfConstraints = 1;
        let objFunc = [0.0, 0.0];
        let constraints = [[0.0, 0.0, 0.0, 0.0]];
        let signItems = ["<=", ">="];
        let signItemsChoices = [0];

        function updateProblemType() {
            problemType = document.querySelector('input[name="problemType"]:checked').value;
            document.getElementById("problemTypeText").innerText = "Problem is: " + problemType;
        }

        function updateObjectiveFunction() {
            const objFuncContainer = document.getElementById("objectiveFunction");
            objFuncContainer.innerHTML = "";

            for (let i = 0; i < amtOfObjVars; i++) {
                const input = document.createElement("input");
                input.type = "number";
                input.value = objFunc[i];
                input.oninput = (e) => {
                    objFunc[i] = parseFloat(e.target.value);
                };

                const label = document.createElement("span");
                label.innerText = `x${i + 1}`;

                objFuncContainer.appendChild(input);
                objFuncContainer.appendChild(label);
            }
        }

        function updateConstraints() {
            const container = document.getElementById("constraintsContainer");
            container.innerHTML = "";

            for (let i = 0; i < amtOfConstraints; i++) {
                const constraintRow = document.createElement("div");
                constraintRow.className = "constraint";

                for (let j = 0; j < amtOfObjVars; j++) {
                    const input = document.createElement("input");
                    input.type = "number";
                    input.value = constraints[i][j];
                    input.oninput = (e) => {
                        constraints[i][j] = parseFloat(e.target.value);
                    };

                    const label = document.createElement("span");
                    label.innerText = `x${j + 1}`;

                    constraintRow.appendChild(input);
                    constraintRow.appendChild(label);
                }

                const signSelect = document.createElement("select");
                signItems.forEach((sign, index) => {
                    const option = document.createElement("option");
                    option.value = index;
                    option.innerText = sign;
                    signSelect.appendChild(option);
                });
                signSelect.value = signItemsChoices[i];
                signSelect.onchange = (e) => {
                    signItemsChoices[i] = parseInt(e.target.value);
                    constraints[i][amtOfObjVars + 1] = signItemsChoices[i];
                };

                const rhsInput = document.createElement("input");
                rhsInput.type = "number";
                rhsInput.value = constraints[i][amtOfObjVars];
                rhsInput.oninput = (e) => {
                    constraints[i][amtOfObjVars] = parseFloat(e.target.value);
                };

                constraintRow.appendChild(signSelect);
                constraintRow.appendChild(rhsInput);

                container.appendChild(constraintRow);
            }
        }

        document.querySelectorAll('input[name="problemType"]').forEach(radio => {
            radio.onchange = updateProblemType;
        });

        document.getElementById("addDecisionVar").onclick = () => {
            amtOfObjVars++;
            objFunc.push(0.0);
            constraints.forEach(constraint => constraint.splice(amtOfObjVars - 1, 0, 0.0));
            updateObjectiveFunction();
            updateConstraints();
        };

        document.getElementById("removeDecisionVar").onclick = () => {
            if (amtOfObjVars > 2) {
                amtOfObjVars--;
                objFunc.pop();
                constraints.forEach(constraint => constraint.splice(amtOfObjVars, 1));
                updateObjectiveFunction();
                updateConstraints();
            }
        };

        document.getElementById("addConstraint").onclick = () => {
            amtOfConstraints++;
            const newConstraint = new Array(amtOfObjVars).fill(0.0);
            newConstraint.push(0.0);  // for sign
            newConstraint.push(0.0);  // for rhs
            constraints.push(newConstraint);
            signItemsChoices.push(0);
            updateConstraints();
        };

        document.getElementById("removeConstraint").onclick = () => {
            if (amtOfConstraints > 1) {
                amtOfConstraints--;
                constraints.pop();
                signItemsChoices.pop();
                updateConstraints();
            }
        };

        function resetRadios() {
            document.querySelector('input[value="Max"]').checked = true;
        }

        document.getElementById("resetButton").onclick = () => {
            problemType = "Max";
            amtOfObjVars = 2;
            amtOfConstraints = 1;
            objFunc = [0.0, 0.0];
            constraints = [[0.0, 0.0, 0.0, 0.0]];
            signItems = ["<=", ">="];
            signItemsChoices = [0];

            updateObjectiveFunction();
            updateConstraints();
            resetRadios();
        };

        function getObjFunc() {
            return objFunc;
        }

        function getConstraints() {
            return constraints;
        }

        function getProblemType() {
            return problemType;
        }

        // Initial render
        updateObjectiveFunction();
        updateConstraints();
        resetRadios();
    </script>

    <py-config>
        packages = [
        ]
        [[fetch]]
        files = ["./twophasesimplex.py"]
    </py-config>
    <script type="py">
        from pyscript import document, display, when, window
        from js import console, getObjFunc, getConstraints, getProblemType
        import copy
    
        document.getElementById("hiddenUntilLoad").removeAttribute("hidden");
        document.getElementById("loadingStatus").hidden = True;

        window.isIframeLoaded = True;
        
        from twophasesimplex import TwoPhaseSimplex

        console.clear();
        
        # Initialize object
        twoPhaseSimplex = TwoPhaseSimplex()

        # Placeholder for tableaus
        tableaus = []

        def renderTableaus():
            # Remove existing tableaus
            for elem in document.querySelectorAll('.tableauContainer'):
                elem.remove()

            container = document.createElement('div')
            container.className = 'tableauContainer'

            for i, tableau in enumerate(tableaus):
                if twoPhaseSimplex.phases[i] == 0:
                    phaseText = "Phase 1"
                elif twoPhaseSimplex.phases[i] == 1:
                    phaseText = "Phase 2"
                else: 
                    phaseText = "Optimal"
                tableauHeader = document.createElement('h3')
                tableauHeader.textContent = f"Tableau {i + 1}"
                container.appendChild(tableauHeader)

                phaseElem = document.createElement('p')
                phaseElem.textContent = phaseText
                phaseElem.style = "margin-top: -19px;"
                container.appendChild(phaseElem)

                # Create header row
                del tHeader[0]
                tHeader.insert(0, f"t - {i+1}")
                headerRow = document.createElement('div')
                headerRow.className = 'row header-row'
                for header in tHeader:
                    headerCell = document.createElement('div')
                    headerCell.className = 'cell'
                    headerCell.textContent = header
                    headerRow.appendChild(headerCell)
                if i != len(tableaus) - 1:
                    headerCell = document.createElement('div')
                    headerCell.className = 'cell'
                    headerCell.textContent = "theta"
                    headerRow.appendChild(headerCell)
                container.appendChild(headerRow)


                # Create tableau rows
                for j, row in enumerate(tableau):
                    rowDiv = document.createElement('div')
                    rowDiv.className = 'row'
                    if j == tRow[i] and tRow[i] != -1:
                        rowDiv.classList.add('highlight')

                    rowLabel = document.createElement('div')
                    rowLabel.className = 'cell'
                    rowLabel.textContent = 'w' if j == 0 else 'z' if j == 1 else f'c {j - 1}'
                    rowDiv.appendChild(rowLabel)

                    for k, value in enumerate(row):
                        cell = document.createElement('div')
                        cell.className = 'cell'
                        cell.textContent = f"{value:.3f}"
                        if k == tCol[i] and tCol[i] != -1:
                            cell.classList.add('highlight')
                        rowDiv.appendChild(cell)
                    if j != 0 and j != 1 and i != len(tableaus) - 1:
                        cell = document.createElement('div')
                        cell.className = 'cell'
                        try: 
                            cell.textContent = f"{(tableaus[i][j][-1] / tableaus[i][j][tCol[i]]):.3f}"
                        except:
                            cell.textContent = f"{float('inf')}"
                        rowDiv.appendChild(cell)
                    container.appendChild(rowDiv)
                document.body.appendChild(container)

        @when("click", "#solveButton")
        def solve(event):
            try:
                twoPhaseSimplex.reset()
                for elem in document.querySelectorAll('.error'):
                    elem.remove()

                objFunc = getObjFunc().to_py()

                constraints = getConstraints().to_py()

                if getProblemType() == "Max":
                    isMin = False
                else:
                    isMin = True

                # objFunc, constraints, isMin = twoPhaseSimplex.testInput(0)

                # Copy and compute
                a = copy.deepcopy(objFunc)
                b = copy.deepcopy(constraints)

                global tableaus, tCol, tRow, tPhase, tHeader
                tableaus = twoPhaseSimplex.doTwoPhase(a, b, isMin)

                twoPhaseSimplex.IMPivotCols.append(-1)
                twoPhaseSimplex.IMPivotRows.append(-1)

                twoPhaseSimplex.IMPhaseType.append(0)
                twoPhaseSimplex.IMPhaseType.append(0)

                tRow = copy.deepcopy(twoPhaseSimplex.IMPivotRows)
                tCol = copy.deepcopy(twoPhaseSimplex.IMPivotCols)
                tHeader = copy.deepcopy(twoPhaseSimplex.IMHeaderRow)
                tPhase = copy.deepcopy(twoPhaseSimplex.IMPhaseType)
                tPhase[-1] = 2
                tPhase[-2] = 2

                twoPhaseSimplex.IMHeaderRow.clear()
                twoPhaseSimplex.IMPivotRows.clear()
                twoPhaseSimplex.IMPivotCols.clear()
                twoPhaseSimplex.IMPhaseType.clear()

                tCol.append(-1)
                tRow.append(-1)

                tHeader.insert(0, "t")

                if len(tableaus) != len(twoPhaseSimplex.phases):
                    twoPhaseSimplex.phases.clear()
                    for item in range(len(tableaus) - 1):
                        twoPhaseSimplex.phases.append(0)
                    twoPhaseSimplex.phases.append(-1)

                renderTableaus()

            except Exception as e:
                for elem in document.querySelectorAll('.error'):
                    elem.remove()
                errorDiv = document.createElement('div')
                errorDiv.className = 'error'
                errorDiv.textContent = "Math Error"
                document.body.appendChild(errorDiv)
                raise

        @when("click", "#resetButton")
        def reset(event):
            twoPhaseSimplex.reset()
            # Remove existing tableaus
            for elem in document.querySelectorAll('.tableauContainer'):
                elem.remove()
            for elem in document.querySelectorAll('.error'):
                elem.remove()

    </script>

</body>

</html>